<!DOCTYPE html>
<html lang="en">
 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload Modals</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: aliceblue;
        }
 
        .button-container {
            height: 100vh;
            display: flex;
            justify-content: center;
            gap: 50px;
            align-items: center;
        }
 
        button {
            width: 200px;
            height: 50px;
            margin: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
 
        button:hover {
            background-color: #0056b3;
        }
 
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
 
        .modal.active {
            display: flex;
            opacity: 1;
        }
 
        .modal-content {
            background-color: #fff;
            display: flex;
            flex-direction: column;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }
 
        .modal-content h2 {
            margin-bottom: 20px;
            text-align: center;
        }
 
        input[type="text"] {
            margin-bottom: 15px;
            border-radius: 5px;
            border: 2px solid black;
            padding: 7px;
        }
 
        input[type="file"] {
            margin-bottom: 15px;
            border-radius: 5px;
            border: 2px dotted black;
            opacity: 50%;
            padding: 23px;
        }
 
        .close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 20px;
            cursor: pointer;
            color: #aaa;
        }
 
        #OK {
            background-color: #4BB543;
            position: relative;
            top: 6px;
            left: 89px;
        }
 
        #number {
            padding: 10px;
            position: relative;
            top: 10px;
        }
 
        #styled-input {
            width: 90%;
            padding: 10px;
            margin-top: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
 
        #roleContainer {
          height: auto;
        }
        .btposition{
            display: flex;
        }
    </style>
</head>
 
<body>
    <div class="button-container">
        <button class="local-button">Local</button>
        <button class="github-button">GitHub</button>
        <button class="folder-button">Select File </button>
        <button class="role-button">Role</button>
    </div>
 
    <div class="modal" id="fileModal">
        <div class="modal-content">
            <span class="close" id="closeModel">&times;</span>
            <h2>Upload a File</h2>
            <input type="file" id="file-upload" webkitdirectory directory multiple>
            <button id="uploadBtn">Upload</button>
        </div>
    </div>
 
    <div class="modal" id="gitModal">
        <div class="modal-content">
            <span class="close" id="closeModel1">&times;</span>
            <h2>Provide a Link to the Repository</h2>
            <input type="text" id="repo-link-input" placeholder="Enter repository link">
            <input type="text" id="token-input" placeholder="Enter GitHub Personal Access Token">
            <button id="uploadBtn1">Upload</button>
        </div>
    </div>
 
    <div class="modal" id="folderModal">
        <div class="modal-content">
            <span class="close" id="closeModel2">&times;</span>
            <h2>Give a Folder Name </h2>
            <label for="root">Root Directory</label>
            <input type="text" name="root" id="root">
            <label for="routers">Routers</label>
            <input type="text" name="routers" id="routers">
            <label for="schemas">Schemas</label>
            <input type="text" name="schemas" id="schemas">
            
            <button id="uploadBtn3">FOLDER SELECTION</button>
            <button id="uploadBtn2">MODEL PROCESSING</button>
        </div>
    </div>
 
    <div class="modal" id="Success">
        <div class="modal-content">
            <span class="close" id="closeModel3">&times;</span>
            <h2>Cloned Success</h2>
            <button id="OK">Go TO Home Page</button>
        </div>
    </div>
    <div class="modal" id="role">
        <div class="modal-content">
            <span class="close" id="closeModel4">&times;</span>
            <h2>Enter the Roles Using Add </h2>
            <div id="roleContainer">
                <input type="text" id="styled-input" placeholder="Role Name">
            </div>
            <div class="btposition">
            <button class="add">Add</button>
            <button class="delete">delete </button>
            <button id="saveButton" onclick="storeRoleInputs()">Save</button>
        </div>
 
 
        </div>
    </div>
 
    <script>
        let rolesArray = [];
        const role = document.querySelector('.add');
        const deleteButton = document.querySelector('.delete');
        const roleContainer = document.getElementById('roleContainer');
        const buttonContainer = document.querySelector('.button-container');
        const fileModal = document.getElementById('fileModal');
        const gitModal = document.getElementById('gitModal');
        const roleData = document.getElementById('role');
        const folderModal = document.getElementById('folderModal');
        const folderButton = document.querySelector('.folder-button');
        const roleButton = document.querySelector('.role-button');
        const Success = document.getElementById('Success');
       
        // Open modals
        role.addEventListener('click', function () {
           
            if (roleContainer.offsetHeight >=50) {
                 roleContainer.style.maxHeight = "330px"
                roleContainer.style.overflow = 'auto';
            }
            const inputBox = document.createElement('input');
            inputBox.setAttribute('type', 'text');
            inputBox.setAttribute('id', 'styled-input');
            inputBox.setAttribute('placeholder', 'Role Name');
            roleContainer.appendChild(inputBox);
        });
        deleteButton.addEventListener('click',function(){
            if (roleContainer.childElementCount > 1){
                console.log(roleContainer.childElementCount)
            roleContainer.removeChild(roleContainer.lastElementChild);
            }
 
        })
       
        const saveButton = document.getElementById('saveButton');
        saveButton.addEventListener('click', storeRoleInputs);
       
        function storeRoleInputs() {
            rolesArray.length = 0; // Clear the array directly
       
            const inputElements = document.querySelectorAll('#roleContainer input[type="text"]');
            inputElements.forEach((input) => {
                if (input.value.trim() !== "") {
                    rolesArray.push(input.value.trim());
                }
            });
       
            console.dir( rolesArray); // Log the array to verify
        }
        document.getElementById('saveButton').addEventListener('click', async function () {
            if (rolesArray.length > 0) { // Ensure rolesArray has entries
                try {
                    const response = await fetch('http://127.0.0.1:8000/process_json/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        // Send `rolesArray` directly if `detail` wrapping is unnecessary
                        body: JSON.stringify(rolesArray)
                    });
       
                    if (!response.ok) {
                        const errorDetails = await response.json();
                        console.error("Error details:", JSON.stringify(errorDetails, null, 2));
                        throw new Error(errorDetails.detail || 'Unknown error occurred.');
                    }
       
                    const result = await response.json();
                    console.log(result);
                    Success.classList.add('active');
       
                    document.getElementById('OK').addEventListener('click', function () {
 
                        closeRole();
                        roleData.style.display = 'block';
                    });
                } catch (error) {
                    alert(`Failed to process data. Details: ${error.message}`);
                }
            } else {
                alert('Please add at least one role before saving.');
            }
        });
       
        roleButton.addEventListener('click', function () {
            roleData.classList.add('active');
           
            buttonContainer.style.display = 'none';
        });
 
        document.querySelector('.local-button').addEventListener('click', function () {
            fileModal.classList.add('active');
            buttonContainer.style.display = 'none';
        });
 
        document.querySelector('.github-button').addEventListener('click', function () {
            gitModal.classList.add('active');
            buttonContainer.style.display = 'none';
        });
        document.querySelector('.folder-button').addEventListener('click', function () {
            folderModal.classList.add('active');
            buttonContainer.style.display = 'none';
        });
 
        // Close modals
        document.getElementById('closeModel').addEventListener('click', closeFileModal);
        document.getElementById('closeModel1').addEventListener('click', closeGitModal);
        document.getElementById('closeModel2').addEventListener('click', closeFolderModal);
        document.getElementById('closeModel3').addEventListener('click', closeSucess);
        document.getElementById('closeModel4').addEventListener('click', closeRole);
 
        /*window.addEventListener('click', function (e) {
            if (e.target === fileModal) closeFileModal();
            if (e.target === gitModal) closeGitModal();
            if (e.target === folderModal) closeFolderModal();
            if (e.target === Success) closeFolderModal();
        });*/
 
        // File Upload Logic
        document.getElementById('uploadBtn').addEventListener('click', async function () {
            const fileInput = document.getElementById('file-upload');
            if (fileInput.files.length > 0) {
                const formData = new FormData();
                const excludeFolders = ['.venv', 'venv', '__pycache__', '.git', '.vscode'];
 
                for (let file of fileInput.files) {
                    const relativePath = file.webkitRelativePath;
                    if (!excludeFolders.some(folder => relativePath.includes(folder))) {
                        formData.append('files', file, relativePath);
                    }
                }
 
                if (formData.has('files')) {
                    try {
                        const response = await fetch('http://127.0.0.1:8000/upload-folder', {
                            method: 'POST',
                            body: formData
                        });
                        const result = await response.json();
                        console.log(result);
                        Success.classList.add('active');
                        document.getElementById('OK').addEventListener('click', function () {
                            closeSucess()
                            closeFileModal();
                            folderButton.style.display = 'block';
                        });
                    } catch (error) {
                        console.error('Error uploading files:', error);
                    }
                } else {
                    alert('No valid files to upload after excluding folders.');
                }
            } else {
                alert('No file selected. Please choose a file.');
            }
        });
 
        // Git Upload Logic
        document.getElementById('uploadBtn1').addEventListener('click', async function () {
            const repoLink = document.getElementById('repo-link-input').value;
            const token = document.getElementById('token-input').value;
            if (repoLink) {
                try {
                    const response = await fetch('http://127.0.0.1:8000/git-link', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            source_path: repoLink,
                            token: token
                        })
                    });
 
                    if (!response.ok) {
                        const errorDetails = await response.json();
                        throw new Error(errorDetails.detail || 'Unknown error occurred.');
                    }
 
                    const result = await response.json();
                    console.log(result);
                    Success.classList.add('active');
                    document.getElementById('OK').addEventListener('click', function () {
                        closeSucess()
                        closeGitModal();
                        folderButton.style.display = 'block';
                    });
                } catch (error) {
                    alert(`Failed to clone the repository. Details: ${error.message}`);
                }
            } else {
                alert('Both repository link and token are required.');
            }
        });
 
        //###############################################################################################################
 
        document.getElementById('uploadBtn2').addEventListener('click', async function () {
 
            const root = document.getElementById('root').value;
            console.log(root)
            const routers = document.getElementById('routers').value;
            console.log(routers)
            const schemas = document.getElementById('schemas').value;
            console.log(schemas)
            if (root && routers && schemas) {
                try {
                    const response = await fetch('http://127.0.0.1:8000/process/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            root_directory: root,
                            routers_name: routers,
                            schemas_name: schemas
                        })
                    });
 
                    if (!response.ok) {
                        const errorDetails = await response.json();
                        throw new Error(errorDetails.detail || 'Unknown error occurred.');
                    }
 
                    const result = await response.json();
                    console.log(result);
                    Success.classList.add('active');
                    document.getElementById('OK').addEventListener('click', function () {
                        closeSucess()
                        closeFolderModal
                        folderButton.style.display = 'block';
                    });
                } catch (error) {
                    alert(`Failed to clone the repository. Details: ${error.message}`);
                }
            } else {
                alert('Both repository link and token are required.');
            }
        });
 
        //#######################################################
        document.getElementById('uploadBtn3').addEventListener('click', async function () {
 
            const root = document.getElementById('root').value;
            console.log(root)
            const routers = document.getElementById('routers').value;
            console.log(routers)
            const schemas = document.getElementById('schemas').value;
            console.log(schemas)
            if (root && routers && schemas) {
                try {
                    const response = await fetch('http://127.0.0.1:8000/copy_folders/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            project_name: root,
                            routers_name: routers,
                            schemas_name: schemas
                        })
                    });
 
                    if (!response.ok) {
                        const errorDetails = await response.json();
                        throw new Error(errorDetails.detail || 'Unknown error occurred.');
                    }
 
                    const result = await response.json();
                    console.log(result);
                    Success.classList.add('active');
                    document.getElementById('OK').addEventListener('click', function () {
                        closeSucess()
                        closeFolderModal()
                        folderButton.style.display = 'block';
                    });
                } catch (error) {
                    alert(`Failed to clone the repository. Details: ${error.message}`);
                }
            } else {
                alert('Both repository link and token are required.');
            }
        });
 
        function closeFileModal() {
            buttonContainer.style.display = 'flex';
            fileModal.classList.remove('active');
        }
 
        function closeGitModal() {
            buttonContainer.style.display = 'flex';
            gitModal.classList.remove('active');
        }
 
        function closeFolderModal() {
            buttonContainer.style.display = 'flex';
            folderModal.classList.remove('active');
        }
        function closeSucess() {
            buttonContainer.style.display = 'flex';
            Success.classList.remove('active');
        }
        function closeRole() {
            buttonContainer.style.display = 'flex';
            roleData.classList.remove('active');
        }
    </script>
</body>
 
</html>